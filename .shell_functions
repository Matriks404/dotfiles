#HACK: Ideally this should be an export in '.profile., but it's not working properly on Debian 11.
OS_NAME="$(uname -s)"

backup_file ()
{
    cp "$1" "$1.bak"
}

edit_backup_excludes ()
{
    target="/usr/local/scripts/backup_job_files/exclude.txt"

    if [ -f "$target" ]; then
        "$SU_CMD" "$EDITOR" "$target"
    fi
}

edit_backup_includes ()
{
    target="/usr/local/scripts/backup_job_files/include.txt"

    if [ -f "$target" ]; then
        "$SU_CMD" "$EDITOR" "$target"
    fi
}

edit_backup_settings ()
{
    target="/usr/local/scripts/backup_job_files/settings.sh"

    if [ -f "$target" ]; then
        "$SU_CMD" "$EDITOR" "$target"
    fi
}

reinstall_backup_script ()
{
    local SOURCE_SCRIPTS_DIR="$HOME/.local/scripts.noexecute"
    local TARGET_SCRIPTS_DIR="/usr/local/scripts"

    "$SU_CMD" mkdir -p "$TARGET_SCRIPTS_DIR"
    "$SU_CMD" install -vm 0744 -o root -g root "${SOURCE_SCRIPTS_DIR}/backup_job.sh" "${TARGET_SCRIPTS_DIR}/backup_job.sh"
    "$SU_CMD" cp -v "${SOURCE_SCRIPTS_DIR}/backup_job.sh.version" "${TARGET_SCRIPTS_DIR}"
}

replace_backup_configuration_files ()
{
    local SOURCE_SCRIPTS_DIR="$HOME/.local/scripts.noexecute"
    local TARGET_SCRIPTS_DIR="/usr/local/scripts"

    "$SU_CMD" mkdir -p "$TARGET_SCRIPTS_DIR"
    "$SU_CMD" cp -rv "${SOURCE_SCRIPTS_DIR}/backup_job_files" "${TARGET_SCRIPTS_DIR}"
}

restart_network_service ()
{
    if [ "$OS_NAME" = "Linux" ]; then
        "$SU_CMD" systemctl restart NetworkManager
    elif [ "$OS_NAME" = "OpenBSD" ]; then
        "$SU_CMD" sh "/etc/netstart"
    fi
}

run_automatic_backup ()
{
    if [ -f "/usr/local/scripts/backup_job.sh" ]; then
        "$SU_CMD" "/usr/local/scripts/backup_job.sh"
    else
        echo -e "Error: Your automatic backup job script is not installed properly."
        echo -e "Do you want to set it up? If so, enter \"Yes.\" (without quotes):"
        echo -en "? "
        read answer
        echo

        if [ "$answer" = "Yes." ]; then
            set_up_automatic_backup
        fi
    fi
}

set_up_automatic_backup ()
{
    OLD_LOCATION="/usr/local/scripts"
    NEW_LOCATION="$HOME/.local/scripts.noexecute"

    SCRIPT_VERSION_FILENAME="backup_job.sh.version"
    FILES_VERSION_FILENAME="backup_job_files/version"

    OLD_BACKUP_SCRIPT_VERSION="$(cat ${OLD_LOCATION}/${SCRIPT_VERSION_FILENAME})"
    OLD_BACKUP_FILES_VERSION="$(cat ${OLD_LOCATION}/${FILES_VERSION_FILENAME})"

    NEW_BACKUP_SCRIPT_VERSION="$(cat ${NEW_LOCATION}/${SCRIPT_VERSION_FILENAME})"
    NEW_BACKUP_FILES_VERSION="$(cat ${NEW_LOCATION}/${FILES_VERSION_FILENAME})"


    if [ -f "/usr/local/scripts/backup_job.sh" ]; then
        echo -e "Info: It looks like, there's already backup job script installed."
        echo -e "Current version is: ${OLD_BACKUP_SCRIPT_VERSION}"
        echo -e "The new version is: ${NEW_BACKUP_SCRIPT_VERSION}\n"

        echo -e "Do you still want to reinstall/upgrade the script? If so, enter \"Yes.\" (without quotes):"
        echo -en "? "
        read answer
        echo

        if [ "$answer" = "Yes." ]; then
            echo -e "Reinstalling/Upgrading the script..."
            reinstall_backup_script
        else
            echo -e "Operation canceled by user."
        fi
    else
        echo -e "Installing the script..."
        reinstall_backup_script
    fi

    if [ -d "/usr/local/scripts/backup_job_files" ]; then
        echo -e "\n\nInfo: It looks like, a directory with backup job configuration at '/usr/local/scripts/backup_job_files' is already present."
        echo -e "Current version is: ${OLD_BACKUP_FILES_VERSION}"
        echo -e "The new version is: ${NEW_BACKUP_FILES_VERSION}\n"

        echo -e "Do you want to replace these files with new fresh ones?"
        echo -e "MAKE SURE YOU KNOW WHAT YOU'RE DOING AND MAKE A COPY OF YOUR EXISTING BACKUP CONFIGURATION DIRECTORY IF NECCESARY!"
        echo -e "\nANYWAY, IF YOU WANT TO DO THIS, ENTER \"Yes.\" (without quotes):"
        echo -en "? "
        read answer
        echo

        if [ "$answer" = "Yes." ]; then
            echo -e "\nReplacing backup configuration files at '/usr/local/scripts/backup_job_files..."
            replace_backup_configuration_files

            first_conf_setup=1
        else
            echo -e "Operation canceled by user."
        fi
    else
        echo -e "\nCopying backup configuration files to '/usr/local/scripts/backup_job_files'..."
        replace_backup_configuration_files

        first_conf_setup=1
    fi

    if [ -f "/etc/debian_version" ]; then
        if [ -f "/etc/cron.daily/backup_job" ]; then
            echo -e "\n\nInfo: It looks like, you already have linked backup job script to '/etc/cron.daily/backup_job'."
            echo -e "Do you want to relink it? If so, enter \"Yes.\" (without quotes):"
            echo -en "? "
            read answer
            echo

            if [ "$answer" = "Yes." ]; then
                relink_backup_script
            else
                echo -e "Operation canceled by user."
            fi
        else
            relink_backup_script
        fi
    else
        echo -e "\nInfo: Unknown operating system. Make sure to add '/usr/local/scripts/backup_job.sh to your system-wide crontab for it to work without user interaction."
    fi

    if [ "$first_conf_setup" = "1" ]; then
        echo -e "\nInfo: For backup system to work, you need to configure your includes, excludes, and settings over in '/usr/local/scripts/backup_job_files' first!"
    fi

    echo -e "\nInfo: If working over ssh and authentication is needed, you need to make sure you have neccesary keys (by using 'ssh-keygen') and you have copied it to your remote device (by using 'ssh-copy-id')."

    #TODO: Make it possible to do it here.
}

# Package updates / System upgrades

su_update_software ()
{
    "$SU_CMD" "$HOME/.local/bin/su-update-software.sh"

    if [ "$OS_NAME" = "Linux" ]; then
        update_software
    fi
}

su_upgrade_system ()
{
    "$SU_CMD" "$HOME/.local/bin/su-upgrade-system.sh"
}

# Functions available only if git is installed
if [ "$(command -v git)" ]; then
    git_commit ()
    {
        local comment="$1"

        git add .
        git commit -m "$comment"
    }

    git_push ()
    {
        local comment="$1"

        git_commit "$comment"
        git push
    }
fi

# Linux-specific functions
if [ "$OS_NAME" = "Linux" ]; then
    # Functions specific to Debian GNU/Linux
    if [ -f "/etc/debian_version" ]; then
        reconfigure_locales ()
        {
            "$SU_CMD" dpkg-reconfigure locales
        }

        relink_backup_script ()
        {
            local CRON_FILE="/etc/cron.daily/backup_job"
            local SCRIPTS_DIR="/usr/local/scripts"

            echo -e "\nCreating a daily cron job in '${CRON_FILE}'..."
            "$SU_CMD" ln -fsv "${SCRIPTS_DIR}/backup_job.sh" "${CRON_FILE}"
        }
    fi

    # Functions specific to Flatpak (if it's installed)
    if [ "$(command -v flatpak)" ]; then
        # Document this function
        create_flatpak_symlinks ()
        {
            TARGET_DIR="$HOME/.local/bin/flatpak-executables"
            mkdir -p "$TARGET_DIR"

            #HACK: We'll use eval here, so OpenBSD's ksh don't complain about this code (even though it is never be executed).
            #TODO: Ideally, this should be inside `.shell_functions.linux` file, or something similar.
            #      This move will eventually happen, in some future reorganization.
            eval '
                declare -A CUSTOM_NAMES
                CUSTOM_NAMES=(
                    ["net._86box._86Box"]="86box"
                    ["org.telegram.desktop"]="telegram"
                )
            '

            flatpak list --app --columns=application | while read -r app_id; do

                # Check if we have a custom name defined
                if [[ -n "${CUSTOM_NAMES[$app_id]}" ]]; then
                    script_name="${CUSTOM_NAMES[$app_id]}"
                else
                    # Default logic: get part after last dot and lowercase it
                    script_name=$(echo "$app_id" | awk -F. '{print $NF}' | tr '[:upper:]' '[:lower:]')

                    # Remove leading underscores (e.g., _86box -> 86box)
                    script_name="${script_name#_}"
                fi

                script_path="$TARGET_DIR/$script_name"

                cat <<EOF > "$script_path"
#!/bin/sh
flatpak run $app_id
EOF

                chmod +x "$script_path"
                echo -e "Mapped: $app_id -> $script_name"
            done

            echo -e "\nFinished! Scripts are in $TARGET_DIR"
        }
    fi

    # Functions specific to Tailscale (if it's installed)
    if [ "$(command -v tailscale)" ]; then
        restart_tailscaled_service ()
        {
            "$SU_CMD" systemctl restart tailscaled
        }

        restart_all_networks ()
        {
            restart_network_service
            restart_tailscaled_service
        }
    fi

    update_software ()
    {
        "$HOME/.local/bin/user-update-software.sh"
    }

    wiki ()
    {
        local article="$1"

        lynx gopher://gopherpedia.com/0/"${article}"
    }
fi
