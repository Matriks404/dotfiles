#HACK: Ideally this should be an export in '.profile., but it's not working properly on Debian 11.
OS_NAME="$(uname -s)"

backup_file ()
{
    cp "$1" "$1.bak"
}

edit_backup_excludes ()
{
    target="/usr/local/scripts/backup_job_files/exclude.txt"

    if [ -f "$target" ]; then
        sudo "$EDITOR" "$target"
    fi
}

edit_backup_includes ()
{
    target="/usr/local/scripts/backup_job_files/include.txt"

    if [ -f "$target" ]; then
        sudo "$EDITOR" "$target"
    fi
}

edit_backup_settings ()
{
    target="/usr/local/scripts/backup_job_files/settings.sh"

    if [ -f "$target" ]; then
        sudo "$EDITOR" "$target"
    fi
}

restart_network_service ()
{
    if [ "$OS_NAME" = "Linux" ]; then
        sudo systemctl restart NetworkManager
    elif [ "$OS_NAME" = "OpenBSD" ]; then
        doas sh "/etc/netstart"
    fi
}

reinstall_backup_script ()
{
    sudo mkdir -p "/usr/local/scripts"
    sudo cp -v "$HOME/.local/scripts.noexecute/backup_job.sh" "/usr/local/scripts"
}

replace_backup_configuration_files ()
{
    sudo mkdir -p "/usr/local/scripts"
    sudo cp -rv "$HOME/.local/scripts.noexecute/backup_job_files" "/usr/local/scripts"
}

run_automatic_backup ()
{
    if [ -f "/usr/local/scripts/backup_job.sh" ]; then
        sudo "/usr/local/scripts/backup_job.sh"
    else
        echo -e "Error: Your automatic backup job script is not installed properly."
        echo -e "Do you want to set it up? If so, enter \"Yes.\" (without quotes):"
        echo -en "? "
        read answer
        echo

        if [ "$answer" = "Yes." ]; then
            set_up_automatic_backup
        fi
    fi
}

set_up_automatic_backup ()
{
    if [ -f "/usr/local/scripts/backup_job.sh" ]; then
        echo -e "Info: It looks like, there's already backup job script installed."
        echo -e "Do you want to reinstall the script? If so, enter \"Yes.\" (without quotes):"
        echo -en "? "
        read answer
        echo

        if [ "$answer" = "Yes." ]; then
            echo -e "Reinstalling the script..."
            reinstall_backup_script
        else
            echo -e "Operation canceled by user."
        fi
    else
        echo -e "Installing the script..."
        reinstall_backup_script
    fi

    if [ -d "/usr/local/scripts/backup_job_files" ]; then
        echo -e "\n\nInfo: It looks like, a directory with backup job configuration at '/usr/local/scripts/backup_job_files' is already present."
        echo -e "Do you want to replace these files with new fresh ones?"
        echo -e "MAKE SURE YOU KNOW WHAT YOU'RE DOING AND MAKE A COPY OF YOUR EXISTING BACKUP CONFIGURATION DIRECTORY IF NECCESARY!"
        echo -e "\nANYWAY, IF YOU WANT TO DO THIS, ENTER \"Yes.\" (without quotes):"
        echo -en "? "
        read answer
        echo

        if [ "$answer" = "Yes." ]; then
            echo -e "Replacing backup configuration files at '/usr/local/scripts/backup_job_files..."
            replace_backup_configuration_files

            first_conf_setup=1
        else
            echo -e "Operation canceled by user."
        fi
    else
        echo -e "Copying backup configuration files to '/usr/local/scripts/backup_job_files'..."
        replace_backup_configuration_files

        first_conf_setup=1
    fi

    if [ -f "/etc/debian_version" ]; then
        if [ -f "/etc/cron.daily/backup_job" ]; then
            echo -e "\n\nInfo: It looks like, you already have linked backup job script to '/etc/cron.daily/backup_job'."
            echo -e "Do you want to relink it? If so, enter \"Yes.\" (without quotes):"
            echo -en "? "
            read answer
            echo

            if [ "$answer" = "Yes." ]; then
                relink_backup_script
            else
                echo -e "Operation canceled by user."
            fi
        else
            relink_backup_script
        fi
    else
        echo -e "\nInfo: Unknown operating system. Make sure to add '/usr/local/scripts/backup_job.sh to your system-wide crontab for it to work without user interaction."
    fi

    if [ "$first_conf_setup" = "1" ]; then
        echo -e "\nInfo: For backup system to work, you need to configure your includes, excludes, and settings over in '/usr/local/scripts/backup_job_files' first!"
    fi

    echo -e "\nInfo: If working over ssh and authentication is needed, you need to make sure you have neccesary keys (by using 'ssh-keygen') and you have copied it to your remote device (by using 'ssh-copy-id')."

    #TODO: Make it possible to do it here.
}

# Package updates / System upgrades

su_update_software ()
{
    if [ "$OS_NAME" = "Linux" ]; then
        sudo "$HOME/.local/bin/su-update-software.sh"
    elif [ "$OS_NAME" = "OpenBSD" ]; then
        doas "$HOME/.local/bin/su-update-software.sh"
    fi

    if [ "$OS_NAME" = "Linux" ]; then
        update_software
    fi
}

su_upgrade_system ()
{
    if [ "$OS_NAME" = "Linux" ]; then
        sudo "$HOME/.local/bin/su-upgrade-system.sh"
    elif [ "$OS_NAME" = "OpenBSD" ]; then
        doas "$HOME/.local/bin/su-upgrade-system.sh"
    fi
}

# Functions available only if git is installed
if [ "$(command -v git)" ]; then
    git_commit ()
    {
        local comment="$1"

        git add .
        git commit -m "$comment"
    }

    git_push ()
    {
        local comment="$1"

        git_commit "$comment"
        git push
    }
fi

# Linux-specific functions
if [ "$OS_NAME" = "Linux" ]; then
    # Functions specific to Debian GNU/Linux
    if [ -f "/etc/debian_version" ]; then
        relink_backup_script ()
        {
            echo -e "Creating a daily cron job in '/etc/cron.daily'..."
            sudo ln -fsv "/usr/local/scripts/backup_job.sh" "/etc/cron.daily/backup_job"
        }
    fi

    # Functions specific to Flatpak (if it's installed)
    if [ "$(command -v flatpak)" ]; then
        # Document this function
        create_flatpak_symlinks ()
        {
            TARGET_DIR="$HOME/.local/bin/flatpak-executables"
            mkdir -p "$TARGET_DIR"

            declare -A CUSTOM_NAMES
            CUSTOM_NAMES=(
                ["net._86box._86Box"]="86box"
                ["org.telegram.desktop"]="telegram"
            )

            flatpak list --app --columns=application | while read -r app_id; do

                # Check if we have a custom name defined
                if [[ -n "${CUSTOM_NAMES[$app_id]}" ]]; then
                    script_name="${CUSTOM_NAMES[$app_id]}"
                else
                    # Default logic: get part after last dot and lowercase it
                    script_name=$(echo "$app_id" | awk -F. '{print $NF}' | tr '[:upper:]' '[:lower:]')

                    # Remove leading underscores (e.g., _86box -> 86box)
                    script_name="${script_name#_}"
                fi

                script_path="$TARGET_DIR/$script_name"

                cat <<EOF > "$script_path"
#!/bin/sh
flatpak run $app_id
EOF

                chmod +x "$script_path"
                echo -e "Mapped: $app_id -> $script_name"
            done

            echo -e "\nFinished! Scripts are in $TARGET_DIR"
        }
    fi

    # Functions specific to Tailscale (if it's installed)
    if [ "$(command -v tailscale)" ]; then
        restart_tailscaled_service ()
        {
            sudo systemctl restart tailscaled
        }

        restart_all_networks ()
        {
            restart_network_service
            restart_tailscaled_service
        }
    fi

    update_software ()
    {
        "$HOME/.local/bin/user-update-software.sh"
    }

    wiki ()
    {
        local article="$1"

        lynx gopher://gopherpedia.com/0/"${article}"
    }
fi
